//this example code shows how to put some text in nametable
//it assumes that you have ASCII-encoded font in the CHR tiles $00-$3f
//it also shows how to detect PAL/NTSC video system

#include "neslib.h"

#include "part1_zx_loading_nam.h"
#include "part1_zx_pilotone_nam.h"

#pragma bss-name (push,"ZEROPAGE")
unsigned char pal_i, fr, i, spr, p, pad, sq_scroll_pos, pause;
unsigned char from_x, tick;
unsigned int frame;
unsigned char imsb, ilsb;
#pragma bss-name (pop);

unsigned char pad_t;
unsigned char tileset;

const unsigned int attr_tbl1[16]={ 0x23d2,0x23d3,0x23d4,0x23d5,0x23d6,0x23d7,0x27d0,0x27d1,0x27d2,0x27d3,0x27d4,0x27d5,0x27d6,0x27d7,0x23d0,0x23d1 };
const unsigned int attr_tbl2[16]={ 0x23d3,0x23d4,0x23d5,0x23d6,0x23d7,0x27d0,0x27d1,0x27d2,0x27d3,0x27d4,0x27d5,0x27d6,0x27d7,0x23d0,0x23d1,0x23d2 };
const unsigned int attr_tbl3[16]={ 0x23d4,0x23d5,0x23d6,0x23d7,0x27d0,0x27d1,0x27d2,0x27d3,0x27d4,0x27d5,0x27d6,0x27d7,0x23d0,0x23d1,0x23d2,0x23d3 };

const unsigned char palette[16]={ 0x0f,0x0f,0x03,0x02,0x0f,0x0f,0x28,0x11,0x0f,0x07,0x17,0x27,0x0f,0x0b,0x1b,0x2b };
const unsigned char palette2[16]={ 0x0f,0x0f,0x03,0x02,0x0f,0x0f,0x28,0x11,0x0f,0x07,0x17,0x27,0x0f,0x0b,0x1b,0x2b };

/*
const unsigned char nt_line[64*4]={
	0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x03,0x04,0x04,0x04,0x05,0x06,0x06,0x06,0x05,0x06,0x06,0x06,0x03,0x04,0x04,0x04,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,
	0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,

	0x04,0x03,0x04,0x04,0x06,0x05,0x06,0x06,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x06,0x05,0x06,0x06,0x04,0x03,0x04,0x04,
	0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,

	0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,
	0x06,0x06,0x05,0x06,0x04,0x04,0x03,0x04,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x04,0x04,0x03,0x04,0x06,0x06,0x05,0x06,

	0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,
	0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x06,0x06,0x06,0x05,0x04,0x04,0x04,0x03,0x04,0x04,0x04,0x03,0x06,0x06,0x06,0x05,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00
};
*/
const unsigned char nt_line[64*4]={
	0x00,0x02,0x32,0x22,0x33,0x0c,0x34,0x35,0x36,0x10,0x37,0x38,0x39,0x14,0x3a,0x3b,0x3c,0x15,0x3d,0x14,0x3e,0x11,0x3f,0x40,0x41,0x0d,0x42,0x43,0x44,0x09,0x45,0x04,
	0x00,0x07,0x00,0x02,0x00,0x05,0x08,0x00,0x00,0x03,0x06,0x00,0x00,0x01,0x04,0x00,0x00,0x01,0x02,0x00,0x00,0x03,0x04,0x00,0x00,0x05,0x06,0x00,0x00,0x07,0x08,0x00,

	0x4c,0x2c,0x4d,0x07,0x08,0x00,0x00,0x05,0x06,0x00,0x00,0x03,0x04,0x00,0x00,0x01,0x07,0x00,0x00,0x00,0x4e,0x00,0x00,0x08,0x03,0x00,0x00,0x06,0x01,0x00,0x4f,0x50,
	0x51,0x3c,0x3d,0x52,0x53,0x54,0x55,0x10,0x56,0x57,0x58,0x0c,0x59,0x1e,0x5a,0x09,0x09,0x1e,0x0a,0x09,0x0c,0x0b,0x0e,0x0d,0x10,0x0f,0x12,0x11,0x14,0x13,0x16,0x15,

	0x44,0x09,0x45,0x04,0x03,0x00,0x00,0x06,0x05,0x00,0x00,0x08,0x07,0x00,0x00,0x00,0x5d,0x00,0x00,0x01,0x06,0x00,0x00,0x03,0x08,0x00,0x00,0x05,0x00,0x02,0x32,0x22,
	0x5e,0x5f,0x60,0x0d,0x46,0x47,0x48,0x11,0x49,0x61,0x62,0x15,0x4c,0x20,0x63,0x20,0x20,0x23,0x21,0x20,0x15,0x24,0x25,0x14,0x11,0x19,0x1a,0x10,0x0d,0x26,0x27,0x0c,

	0x01,0x00,0x4f,0x50,0x64,0x15,0x3d,0x65,0x66,0x11,0x3f,0x40,0x67,0x0d,0x42,0x0c,0x68,0x0c,0x34,0x69,0x36,0x10,0x37,0x38,0x6a,0x14,0x3a,0x6b,0x4c,0x2c,0x4d,0x07,
	0x00,0x04,0x01,0x00,0x00,0x06,0x03,0x00,0x00,0x08,0x05,0x00,0x00,0x00,0x6c,0x00,0x00,0x08,0x07,0x00,0x00,0x06,0x05,0x00,0x00,0x04,0x03,0x00,0x00,0x02,0x01,0x00
};



const unsigned char logo_bottom[]={
	  0,  0,0xb8,1,
	  8,  0,0xb9,1,
	 16,  0,0xba,1,
	 24,  0,0xbb,1,
	 32,  0,0xbc,1,
	 40,  0,0xbd,1,
	 48,  0,0xbe,1,
	 56,  0,0xbf,1,
	  0,  8,0xc8,1,
	  8,  8,0xc9,1,
	 16,  8,0xca,1,
	 24,  8,0xcb,1,
	 32,  8,0xcc,1,
	 40,  8,0xcd,1,
	 48,  8,0xce,1,
	 56,  8,0xcf,1,
	  0, 16,0xd8,1,
	  8, 16,0xd9,1,
	 16, 16,0xda,1,
	 24, 16,0xdb,1,
	 32, 16,0xdc,1,
	 40, 16,0xdd,1,
	 48, 16,0xde,1,
	 56, 16,0xdf,1,
	  0, 24,0xe8,1,
	  8, 24,0xe9,1,
	 16, 24,0xea,1,
	 24, 24,0xeb,1,
	 32, 24,0xec,1,
	 40, 24,0xed,1,
	 48, 24,0xee,1,
	 56, 24,0xef,1,
	128
};

const unsigned char logo_title[]={
	  0,  0,0xf0,1,
	  8,  0,0xf1,1,
	 16,  0,0xf2,1,
	 24,  0,0xf3,1,
	 32,  0,0xf4,1,
	 40,  0,0xf5,1,
	 48,  0,0xf6,1,
	 56,  0,0xf7,1,
	  0,  8,0xf8,1,
	  8,  8,0xf9,1,
	 16,  8,0xfa,1,
	 24,  8,0xfb,1,
	 32,  8,0xfc,1,
	 40,  8,0xfd,1,
	 48,  8,0xfe,1,
	 56,  8,0xff,1,
	128
};



//put a string into the nametable

void put_str(unsigned int adr,const char *str)
{
	vram_adr(adr);

	while(1)
	{
		if(!*str) break;

		vram_put((*str++)-0x20);//-0x20 because ASCII code 0x20 is placed in tile 0 of the CHR
	}
}



//bus conflict значит, что в ПЗУ можно писать только тот байт, который там уже есть
//иначе не сработает запись (будет борьба уровней)

const unsigned char bus_conflict[4]={ 0x00,0x01,0x02,0x03 };

void cnrom_set_bank(unsigned char bank)
{
	unsigned char *ptr;
	
	bank&=3;	//есть платы, у которых больше 4 банков, например 16, но для простоты пока так
	
	ptr=(unsigned char*)&bus_conflict[bank];
	
	*ptr=bank;
}

//init data for the update list, it contains MSB and LSB of a tile address
//in the nametable, then the tile number

static unsigned char list[7+7+7+7+28+28+9+1];
const unsigned char list_init[7+7+7+7+28+28+9+1]={
	MSB(NTADR_A(8,8))|NT_UPD_HORZ,LSB(NTADR_A(8,8)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(8,9))|NT_UPD_HORZ,LSB(NTADR_A(8,9)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(8,10))|NT_UPD_HORZ,LSB(NTADR_A(8,10)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(8,11))|NT_UPD_HORZ,LSB(NTADR_A(8,11)),4,1,1,1,1,//horizontal update sequence

	MSB(NTADR_A(12,8))|NT_UPD_HORZ,LSB(NTADR_A(12,8)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(12,9))|NT_UPD_HORZ,LSB(NTADR_A(12,9)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(12,10))|NT_UPD_HORZ,LSB(NTADR_A(12,10)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(12,11))|NT_UPD_HORZ,LSB(NTADR_A(12,11)),4,1,1,1,1,//horizontal update sequence

	MSB(NTADR_A(16,8))|NT_UPD_HORZ,LSB(NTADR_A(16,8)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(16,9))|NT_UPD_HORZ,LSB(NTADR_A(16,9)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(16,10))|NT_UPD_HORZ,LSB(NTADR_A(16,10)),4,1,1,1,1,//horizontal update sequence
	MSB(NTADR_A(16,11))|NT_UPD_HORZ,LSB(NTADR_A(16,11)),4,1,1,1,1,//horizontal update sequence

	MSB(0x23d2),LSB(0x23d2),0,
	MSB(0x23d3),LSB(0x23d3),(1 << 6) | (1 << 4) | (1 << 2) | (1 << 0),
	MSB(0x23d4),LSB(0x23d4),(1 << 6) | (1 << 4) | (1 << 2) | (1 << 0),

	NT_UPD_EOF
};


void main(void)
{

/*	
	put_str(NTADR_A(2,2),"HELLO, WORLD!");
	put_str(NTADR_A(2,6),"THIS CODE PRINTS SOME TEXT");
	put_str(NTADR_A(2,7),"USING ASCII-ENCODED CHARSET");
	put_str(NTADR_A(2,8),"(WITH CAPITAL LETTERS ONLY)");
	put_str(NTADR_A(2,10),"TO USE CHR MORE EFFICIENTLY");
	put_str(NTADR_A(2,11),"YOU'D NEED A CUSTOM ENCODING");
	put_str(NTADR_A(2,12),"AND A CONVERSION TABLE");

	put_str(NTADR_A(2,16),"CURRENT VIDEO MODE IS");

	if(ppu_system()) put_str(NTADR_A(24,16),"NTSC"); else put_str(NTADR_A(24,16),"PAL");
*/

	from_x=0;
	tileset=0;
	
	cnrom_set_bank(tileset);
	

//	oam_spr(30*8,172,1,0,0);

	pal_bg(palette);
	pal_spr(palette2);


	vram_adr(NAMETABLE_B);
	vram_unrle(nametable_logo_sq2);

	vram_adr(NAMETABLE_A);
	vram_unrle(nametable_logo_sq1);

	memcpy(list,list_init,sizeof(list_init));
	
	set_vram_update(list);

	sq_scroll_pos=0;
	pause=10;

	p=0;
	music_play(0);

//	pal_col(1,0xff);
	pal_col(2,0x0f);
	ppu_on_all();//enable rendering

	while(1)
	{

		if (from_x>5 && from_x<14){
		// Set coords for restore BG

			imsb=(from_x-6)<<2;
			list[0]=MSB(NTADR_B(imsb,8))|NT_UPD_HORZ;
			list[1]=LSB(NTADR_B(imsb,8));

			list[7]=MSB(NTADR_B(imsb,9))|NT_UPD_HORZ;
			list[8]=LSB(NTADR_B(imsb,9));

			list[14]=MSB(NTADR_B(imsb,10))|NT_UPD_HORZ;
			list[15]=LSB(NTADR_B(imsb,10));
	
			list[21]=MSB(NTADR_B(imsb,11))|NT_UPD_HORZ;
			list[22]=LSB(NTADR_B(imsb,11));

		}
		if (from_x<6){
		// Set coords for restore BG
			imsb=8+(from_x<<2);
			list[0]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[1]=LSB(NTADR_A(imsb,8));

			list[7]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[8]=LSB(NTADR_A(imsb,9));

			list[14]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[15]=LSB(NTADR_A(imsb,10));
	
			list[21]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[22]=LSB(NTADR_A(imsb,11));

		}
		if (from_x>13){
		// Set coords for restore BG
			imsb=(from_x-14)<<2;
			list[0]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[1]=LSB(NTADR_A(imsb,8));

			list[7]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[8]=LSB(NTADR_A(imsb,9));

			list[14]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[15]=LSB(NTADR_A(imsb,10));
	
			list[21]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[22]=LSB(NTADR_A(imsb,11));

		}

		if (from_x>4 && from_x<13){
		// Set coords for draw logo
			imsb=(from_x-5)<<2;
			list[28]=MSB(NTADR_B(imsb,8))|NT_UPD_HORZ;
			list[29]=LSB(NTADR_B(imsb,8));
			list[35]=MSB(NTADR_B(imsb,9))|NT_UPD_HORZ;
			list[36]=LSB(NTADR_B(imsb,9));
			list[42]=MSB(NTADR_B(imsb,10))|NT_UPD_HORZ;
			list[43]=LSB(NTADR_B(imsb,10));
			list[49]=MSB(NTADR_B(imsb,11))|NT_UPD_HORZ;
			list[50]=LSB(NTADR_B(imsb,11));
		}
		if (from_x<5){
		// Set coords for draw logo
			imsb=12+(from_x<<2);
			list[28]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[29]=LSB(NTADR_A(imsb,8));
			list[35]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[36]=LSB(NTADR_A(imsb,9));
			list[42]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[43]=LSB(NTADR_A(imsb,10));
			list[49]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[50]=LSB(NTADR_A(imsb,11));
		}
		if (from_x>12){
		// Set coords for draw logo
			imsb=(from_x-13)<<2;
			list[28]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[29]=LSB(NTADR_A(imsb,8));
			list[35]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[36]=LSB(NTADR_A(imsb,9));
			list[42]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[43]=LSB(NTADR_A(imsb,10));
			list[49]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[50]=LSB(NTADR_A(imsb,11));
		}
////////////////////////////
		if (from_x>3 && from_x<12){
		// Set coords for draw logo
			imsb=(from_x-4)<<2;
			list[56]=MSB(NTADR_B(imsb,8))|NT_UPD_HORZ;
			list[57]=LSB(NTADR_B(imsb,8));
			list[63]=MSB(NTADR_B(imsb,9))|NT_UPD_HORZ;
			list[64]=LSB(NTADR_B(imsb,9));
			list[70]=MSB(NTADR_B(imsb,10))|NT_UPD_HORZ;
			list[71]=LSB(NTADR_B(imsb,10));
			list[77]=MSB(NTADR_B(imsb,11))|NT_UPD_HORZ;
			list[78]=LSB(NTADR_B(imsb,11));
		}
		if (from_x<4){
		// Set coords for draw logo
			imsb=16+(from_x<<2);
			list[56]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[57]=LSB(NTADR_A(imsb,8));
			list[63]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[64]=LSB(NTADR_A(imsb,9));
			list[70]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[71]=LSB(NTADR_A(imsb,10));
			list[77]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[78]=LSB(NTADR_A(imsb,11));
		}
		if (from_x>11){
		// Set coords for draw logo
			imsb=(from_x-12)<<2;
			list[56]=MSB(NTADR_A(imsb,8))|NT_UPD_HORZ;
			list[57]=LSB(NTADR_A(imsb,8));
			list[63]=MSB(NTADR_A(imsb,9))|NT_UPD_HORZ;
			list[64]=LSB(NTADR_A(imsb,9));
			list[70]=MSB(NTADR_A(imsb,10))|NT_UPD_HORZ;
			list[71]=LSB(NTADR_A(imsb,10));
			list[77]=MSB(NTADR_A(imsb,11))|NT_UPD_HORZ;
			list[78]=LSB(NTADR_A(imsb,11));
		}


		imsb=from_x<<2;
		list[3]=nt_line[imsb];
		list[4]=nt_line[imsb+1];
		list[5]=nt_line[imsb+2];
		list[6]=nt_line[imsb+3];

		imsb+=64;
		list[10]=nt_line[imsb];
		list[11]=nt_line[imsb+1];
		list[12]=nt_line[imsb+2];
		list[13]=nt_line[imsb+3];

		imsb+=64;
		list[17]=nt_line[imsb];
		list[18]=nt_line[imsb+1];
		list[19]=nt_line[imsb+2];
		list[20]=nt_line[imsb+3];

		imsb+=64;
		list[24]=nt_line[imsb];
		list[25]=nt_line[imsb+1];
		list[26]=nt_line[imsb+2];
		list[27]=nt_line[imsb+3];


		list[31]=0xb0;
		list[32]=0xb1;
		list[33]=0xb2;
		list[34]=0xb3;
		list[59]=0xb4;
		list[60]=0xb5;
		list[61]=0xb6;
		list[62]=0xb7;

		list[38]=0xc0;
		list[39]=0xc1;
		list[40]=0xc2;
		list[41]=0xc3;
		list[66]=0xc4;
		list[67]=0xc5;
		list[68]=0xc6;
		list[69]=0xc7;

		list[45]=0xd0;
		list[46]=0xd1;
		list[47]=0xd2;
		list[48]=0xd3;
		list[73]=0xd4;
		list[74]=0xd5;
		list[75]=0xd6;
		list[76]=0xd7;

		list[52]=0xe0;
		list[53]=0xe1;
		list[54]=0xe2;
		list[55]=0xe3;
		list[80]=0xe4;
		list[81]=0xe5;
		list[82]=0xe6;
		list[83]=0xe7;

		list[84]=MSB(attr_tbl1[from_x]);
		list[85]=LSB(attr_tbl1[from_x]);

		list[87]=MSB(attr_tbl2[from_x]);
		list[88]=LSB(attr_tbl2[from_x]);

		list[90]=MSB(attr_tbl3[from_x]);
		list[91]=LSB(attr_tbl3[from_x]);


		scroll(sq_scroll_pos<<5, 0);

		ppu_wait_nmi();
		


		if (!(fr&1)) {
			++sq_scroll_pos;
			++from_x;
		}

		++fr;

		if (fr>29) {
			fr=0;
		}

		if (from_x>15) sq_scroll_pos=from_x=0;
		
		spr=0;
		spr=oam_meta_spr(12*8,12*8-1,spr,logo_bottom);

		++tick;
		if(tick=50) ++frame;
		if(frame==482)
		{
			pal_col(2,7);
			frame=0;
			spr=oam_meta_spr(12*8,16*8-1,spr,logo_title);
		}
	}
}